@use "sass:map";
@use "config" as *;
@use "tokens" as *;
@use "utilities" as *;
@use "base" as *;
@use "core/validations.core" as *;
@use "core/colors.core" as *;
@use "core/utils.core" as *;

/*
 * ================ Internal and Derived Variables ================
 *
 * This file extracts values from configuration wrappers and creates
 * flat variables for internal framework use. Maintains the existing API
 * while internally using the new map structure.
 *
 * VALIDATION ORDER: Critical validations run first (fail fast)
 * VARIABLE EXTRACTION: Flat variables derived from wrapper maps
 * API COMPATIBILITY: Same variable names as before, different sources
 */

/*
 * ================ Validation Phase ================
 * Critical validations that must pass before processing
 */

// Validate all configuration structures
$_framework-valid: validate-framework-config($framework);
$_utilities-valid: validate-utilities-config($utilities);
$_tokens-valid: validate-tokens-structure($tokens);
$_base-valid: validate-base-config($base);

@include validate-themes($themes, $primary-theme);

// Extract and validate responsive configuration
$framework-responsive-breakpoints: map.get($framework, responsive-breakpoints);
$token-breakpoints: map.get($tokens, breakpoints);
$_responsive-valid: validate-responsive-breakpoints(
  $framework-responsive-breakpoints,
  $token-breakpoints
);

/*
 * ================ Framework Configuration Variables ================
 * Extracted from $framework wrapper for internal use
 */

$enable-reset: map.get($framework, reset);
$enable-base: map.get($framework, base);
$css-variables: map.get($framework, css-variables);
$responsive-breakpoints: map.get($framework, responsive-breakpoints);

/*
 * ================ Utility Configuration Variables ================
 * Extracted from $utilities wrapper for internal use
 */

// Global utility settings

$utilities-responsive: map.get(utilities, config, responsive);

// Processed values for framework use
$prefix: map.get(utilities, config, prefix);
$hover-suffix: map.get(utilities, config, hover-suffix);
$important: map.get(utilities, config, important);

// Individual utility class controls (flat variables for easy access)
$themes: map.get($tokens, themes);
$primary-theme: map.get($framework, primary-theme);

$template-background-colors: map.get($utilities, classes, background-colors) != "";
$generate-background-opacity: map.get($utilities, classes, background-opacity) != "";
$generate-text-colors: map.get($utilities, classes, text-colors) != "";
$generate-text-opacity: map.get($utilities, classes, text-opacity) != "";
$generate-background-gradients: map.get($utilities, classes, background-gradients) != "";
$generate-text-gradients: map.get($utilities, classes, text-gradients) != "";
$generate-border-gradients: map.get($utilities, classes, border-gradients) != "";
$generate-scrim-gradients: map.get($utilities, classes, scrim-gradients) != "";
$generate-opacities: map.get($utilities, classes, opacities) != "";

$generate-font-sizes: map.get($utilities, classes, font-sizes) != "";
$generate-font-weights: map.get($utilities, classes, font-weights) != "";
$generate-font-families: map.get($utilities, classes, font-families) != "";
$generate-line-heights: map.get($utilities, classes, line-heights) != "";
$generate-letter-spacing: map.get($utilities, classes, letter-spacing) != "";
$generate-text-alignment: map.get($utilities, classes, text-alignment) != "";
$generate-text-transforms: map.get($utilities, classes, text-transforms) != "";
$generate-text-decorations: map.get($utilities, classes, text-decorations) != "";
$generate-text-truncation: map.get($utilities, classes, text-truncation) != "";
$generate-style-guide: map.get($utilities, classes, style-guide) != "";

$generate-margins: map.get($utilities, classes, margins) != "";
$generate-paddings: map.get($utilities, classes, paddings) != "";

$generate-widths: map.get($utilities, classes, widths) != "";
$generate-heights: map.get($utilities, classes, heights) != "";
$generate-viewport-widths: map.get($utilities, classes, viewport-widths) != "";
$generate-viewport-heights: map.get($utilities, classes, viewport-heights) != "";
$generate-max-widths: map.get($utilities, classes, max-widths) != "";
$generate-max-heights: map.get($utilities, classes, max-heights) != "";

$generate-border-positions: map.get($utilities, classes, border-positions) != "";
$generate-border-colors: map.get($utilities, classes, border-colors) != "";
$generate-border-widths: map.get($utilities, classes, border-widths) != "";
$generate-border-styles: map.get($utilities, classes, border-styles) != "";
$generate-border-radius: map.get($utilities, classes, border-radius) != "";

$generate-shadows: map.get($utilities, classes, shadows) != "";

$generate-display: map.get($utilities, classes, display) != "";
$generate-position: map.get($utilities, classes, position) != "";
$generate-overflow: map.get($utilities, classes, overflow) != "";

$generate-cursors: map.get($utilities, classes, cursors) != "";
$generate-css-variables: map.get($utilities, classes, css-variables) != "";

/*
 * ================ Design Token Variables ================
 * Extracted from $tokens wrapper - maintains existing API names
 */

// Typography tokens
$typography-tokens: map.get($tokens, typography);
$font-families: map.get($typography-tokens, families);
$font-weights: map.get($typography-tokens, weights);
$font-sizes: map.get($typography-tokens, sizes);
$modular-scale: map.get($typography-tokens, modular-scale);
$line-heights: map.get($typography-tokens, line-heights);
$tracking: map.get($typography-tokens, tracking);
$style-guide-combinations: map.get($typography-tokens, style-guide);

// Spacing tokens
$spacing-tokens: map.get($tokens, spacing);
$space-base: map.get($spacing-tokens, base);
$spacing-scale: map.get($spacing-tokens, scale);
$size-percentages: map.get($spacing-tokens, percentages);

// Responsive tokens - UNIFIED NAMING
$breakpoints: map.get($tokens, breakpoints);

// Effect tokens
$effects-tokens: map.get($tokens, effects);
$border-radius: map.get($effects-tokens, border-radius);
$border-widths: map.get($effects-tokens, border-widths);
$border-styles: map.get($effects-tokens, border-styles);
$opacity-scale: map.get($effects-tokens, opacity-scale);
$shadow-scale: map.get($effects-tokens, shadow-scale);
$shadow-color: map.get($effects-tokens, shadow-color);
$gradients: map.get($effects-tokens, gradients);
$gradient-default-type: map.get($effects-tokens, gradient-default-type);

// Interaction tokens
$interaction-tokens: map.get($tokens, interaction);
$cursor-types: map.get($interaction-tokens, cursor-types);
$transition-duration: map.get($interaction-tokens, transition-duration);
$transition-easing: map.get($interaction-tokens, transition-easing);

/*
 * ================ Base Configuration Variables ================
 * Extracted from $base wrapper for component styling
 */

// Page configuration
$page-config: map.get($base, page);
$page-background-color: map.get($page-config, background-color);

// Typography configuration
$typography-config: map.get($base, typography);
$body-font-family: map.get($typography-config, body-font-family);
$body-font-size: map.get($typography-config, body-font-size);
$body-font-weight: map.get($typography-config, body-font-weight);
$body-line-height: map.get($typography-config, body-line-height);
$body-text-color: map.get($typography-config, body-text-color);
$heading-font-family: map.get($typography-config, heading-font-family);
$heading-font-weight: map.get($typography-config, heading-font-weight);
$heading-text-color: map.get($typography-config, heading-text-color);
$list-marker-color: map.get($typography-config, list-marker-color);
$code-text-color: map.get($typography-config, code-text-color);
$code-background-color: map.get($typography-config, code-background-color);
$kbd-text-color: map.get($typography-config, kbd-text-color);
$kbd-background-color: map.get($typography-config, kbd-background-color);

// Form configuration
$forms-config: map.get($base, forms);
$input-border-color: map.get($forms-config, input-border-color);
$input-focus-color: map.get($forms-config, input-focus-color);
$input-placeholder-color: map.get($forms-config, input-placeholder-color);
$input-disabled-color: map.get($forms-config, input-disabled-color);

// Button configuration
$buttons-config: map.get($base, buttons);
$button-background-color: map.get($buttons-config, background-color);
$button-border-color: map.get($buttons-config, border-color);
$button-text-color: map.get($buttons-config, text-color);

// Link configuration
$links-config: map.get($base, links);
$link-text-color: map.get($links-config, text-color);
$link-decoration-color: map.get($links-config, decoration-color);
$link-hover-color: map.get($links-config, hover-color);

// Table configuration
$tables-config: map.get($base, tables);
$table-border-color: map.get($tables-config, border-color);
$table-header-text-color: map.get($tables-config, header-text-color);
$table-header-background: map.get($tables-config, header-background);
$table-cell-text-color: map.get($tables-config, cell-text-color);

// Effects configuration
$effects-config: map.get($base, effects);
$border-default-color: map.get($effects-config, border-color);
$border-default-width: map.get($effects-config, border-width);
$border-default-style: map.get($effects-config, border-style);
$border-default-radius: map.get($effects-config, border-radius);
$shadow-default-color: map.get($effects-config, shadow-color);
$shadow-default-softness: map.get($effects-config, shadow-softness);
$shadow-default-horizontal: map.get($effects-config, shadow-horizontal);
$shadow-default-vertical: map.get($effects-config, shadow-vertical);
$shadow-default-hardness: map.get($effects-config, shadow-hardness);
$shadow-invert-alpha: map.get($effects-config, shadow-invert-alpha);

// Animation configuration
$animation-config: map.get($base, animation);
$transition-default-duration: map.get($animation-config, transition-duration);
$transition-default-easing: map.get($animation-config, transition-easing);

/*
 * ================ Color System Validation Status ================
 * Verification that color system is properly configured
 */

// Validate gradient configuration if gradient utilities are enabled
@if $generate-background-gradients or $generate-text-gradients or $generate-border-gradients {
  @if not map.has-key($gradients, brand) {
    @warn "Brand gradient not defined in gradients configuration. Generic gradient utilities may not work properly.";
  }
}

/*
 * ================ Template Validation ================
 * Verify template placeholders are valid
 */

@if $generate-background-colors {
  $bg-template: map.get($utilities, classes, background-colors);
  @if not(string.index($bg-template, "{color}") or string.index($bg-template, "{abbr(color)}")) {
    @error "Background colors template must contain {color} or {abbr(color)} placeholder. Current: '#{$bg-template}'";
  }
}

@if $generate-text-colors {
  $text-template: map.get($utilities, classes, text-colors);
  @if not(string.index($text-template, "{color}") or string.index($text-template, "{abbr(color)}"))
  {
    @error "Text colors template must contain {color} or {abbr(color)} placeholder. Current: '#{$text-template}'";
  }
}

@if $generate-background-gradients or $generate-text-gradients or $generate-border-gradients {
  $gradient-templates: (
    background-gradients: map.get($utilities, classes, background-gradients),
    text-gradients: map.get($utilities, classes, text-gradients),
    border-gradients: map.get($utilities, classes, border-gradients),
  );

  @each $type, $template in $gradient-templates {
    @if $template != "" and not string.index($template, "{gradient}") {
      @error "#{$type} template must contain {gradient} placeholder. Current: '#{$template}'";
    }
  }
}
